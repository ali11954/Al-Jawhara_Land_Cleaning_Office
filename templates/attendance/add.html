{% extends "base.html" %}

{% block title %}إضافة حضور{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- رأس الصفحة -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 text-gray-800">
            <i class="fas fa-plus-circle text-primary"></i>
            إضافة سجل حضور
        </h1>
        <div class="d-flex align-items-center gap-2">
            <a href="{{ url_for('attendance_index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-right"></i> العودة
            </a>
            <a href="{{ url_for('prepare_attendance') }}" class="btn btn-success">
                <i class="fas fa-clipboard-check"></i> نظام التحضير
            </a>
        </div>
    </div>

    <!-- بطاقة إضافة الحضور -->
    <div class="card shadow">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">بيانات الحضور</h6>
        </div>
        <div class="card-body">
            <form id="attendanceForm" method="POST">
                <div class="row g-3">
                    <!-- اختيار الموظف -->
                    <div class="col-md-6">
                        <label for="employee_id" class="form-label">الموظف <span class="text-danger">*</span></label>
                        <select class="form-control" id="employee_id" name="employee_id" required>
                            <option value="">-- اختر الموظف --</option>
                            {% for employee in employees %}
                            <option value="{{ employee.id }}">{{ employee.full_name }} - {{ employee.position }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- اختيار التاريخ -->
                    <div class="col-md-6">
                        <label for="date" class="form-label">التاريخ <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="date" name="date"
                               value="{{ default_date }}" required>
                    </div>

                    <!-- حالة الحضور -->
                    <div class="col-md-4">
                        <label for="status" class="form-label">الحالة <span class="text-danger">*</span></label>
                        <select class="form-control" id="status" name="status" required>
                            <option value="">-- اختر الحالة --</option>
                            <option value="present">حاضر</option>
                            <option value="absent">غائب</option>
                            <option value="late">متأخر</option>
                        </select>
                    </div>

                    <!-- نوع الوردية -->
                    <div class="col-md-4">
                        <label for="shift_type" class="form-label">نوع الوردية <span class="text-danger">*</span></label>
                        <select class="form-control" id="shift_type" name="shift_type" required>
                            <option value="">-- اختر الوردية --</option>
                            <option value="morning">صباحية</option>
                            <option value="evening">مسائية</option>
                        </select>
                    </div>

                    <!-- الوقت (اختياري) -->
                    <div class="col-md-4">
                        <label class="form-label">الوقت (اختياري)</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="time" class="form-control" id="check_in" name="check_in"
                                       placeholder="الحضور">
                            </div>
                            <div class="col-6">
                                <input type="time" class="form-control" id="check_out" name="check_out"
                                       placeholder="الانصراف">
                            </div>
                        </div>
                    </div>

                    <!-- الملاحظات -->
                    <div class="col-12">
                        <label for="notes" class="form-label">ملاحظات</label>
                        <textarea class="form-control" id="notes" name="notes"
                                  rows="3" placeholder="ملاحظات إضافية..."></textarea>
                    </div>

                    <!-- أزرار -->
                    <div class="col-12">
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> حفظ الحضور
                            </button>
                            <button type="reset" class="btn btn-outline-secondary">
                                <i class="fas fa-undo"></i> مسح الكل
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('attendanceForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    fetch('{{ url_for("add_attendance") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            setTimeout(() => {
                window.location.href = '{{ url_for("attendance_index") }}';
            }, 2000);
        } else {
            showAlert('error', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'حدث خطأ أثناء الحفظ');
    });
});

function showAlert(type, message) {
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger'
    }[type];

    const alertDiv = document.createElement('div');
    alertDiv.className = `alert ${alertClass} alert-dismissible fade show mt-3`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.querySelector('.card-body').appendChild(alertDiv);

    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// إظهار/إخفاء حقول الوقت حسب الحالة
document.getElementById('status').addEventListener('change', function() {
    const timeFields = document.querySelector('.row.g-2').parentElement;
    if (this.value === 'present') {
        timeFields.style.opacity = '1';
    } else {
        timeFields.style.opacity = '0.5';
    }
});
</script>

<style>
.form-label {
    font-weight: 600;
    margin-bottom: 0.5rem;
}
</style>
{% endblock %}
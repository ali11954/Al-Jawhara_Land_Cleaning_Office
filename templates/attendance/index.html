{% extends "base.html" %}

{% block title %}سجلات الحضور{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- رأس الصفحة -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 text-gray-800">
            <i class="fas fa-calendar-check text-primary"></i>
            سجلات الحضور
        </h1>
        <div class="d-flex align-items-center gap-2">
            <!-- زر التحضير -->
            <a href="{{ url_for('prepare_attendance') }}" class="btn btn-success">
                <i class="fas fa-clipboard-check"></i> نظام التحضير
            </a>
            <!-- زر إضافة حضور -->
            <a href="{{ url_for('add_attendance') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> إضافة حضور
            </a>
        </div>
    </div>

    <!-- بطاقة التحكم في التاريخ -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="card-title">
                        <i class="fas fa-calendar-alt text-primary"></i>
                        تاريخ العرض:
                        <span class="text-info">{{ selected_date.strftime('%Y-%m-%d') }}</span>
                    </h5>
                    {% if selected_date != today %}
                    <small class="text-muted">عرض بيانات تاريخ سابق</small>
                    {% endif %}
                </div>
                <div class="col-md-6 text-end">
                    <div class="btn-group" role="group">
                        <a href="{{ url_for('attendance_index', date=prev_date) }}"
                           class="btn btn-outline-primary">
                            <i class="fas fa-chevron-right"></i> اليوم السابق
                        </a>
                        <a href="{{ url_for('attendance_index', date=today) }}"
                           class="btn btn-primary">
                            اليوم الحالي
                        </a>
                        <a href="{{ url_for('attendance_index', date=next_date) }}"
                           class="btn btn-outline-primary">
                            اليوم التالي <i class="fas fa-chevron-left"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- قسم الفلترة -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-filter me-2"></i>فلترة سجلات الحضور
            </h6>
        </div>
        <div class="card-body">
            <form method="GET" class="row g-3">
                <!-- فلترة التاريخ -->
                <div class="col-md-3">
                    <label for="date" class="form-label">التاريخ</label>
                    <input type="date" class="form-control" id="date" name="date"
                           value="{{ selected_date.strftime('%Y-%m-%d') }}">
                </div>

                <!-- فلترة الموظف -->
                <div class="col-md-3">
                    <label for="employee_id" class="form-label">الموظف</label>
                    <select class="form-control" id="employee_id" name="employee_id">
                        <option value="">جميع الموظفين</option>
                        {% for employee in employees %}
                        <option value="{{ employee.id }}"
                                {% if selected_employee_id == employee.id %}selected{% endif %}>
                            {{ employee.full_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- فلترة الشركة -->
                <div class="col-md-3">
                    <label for="company_id" class="form-label">الشركة</label>
                    <select class="form-control" id="company_id" name="company_id">
                        <option value="">جميع الشركات</option>
                        {% for company in companies %}
                        <option value="{{ company.id }}"
                                {% if selected_company_id == company.id %}selected{% endif %}>
                            {{ company.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- فلترة الوردية -->
                <div class="col-md-3">
                    <label for="shift_type" class="form-label">الوردية</label>
                    <select class="form-control" id="shift_type" name="shift_type">
                        <option value="all">جميع الورديات</option>
                        <option value="morning" {% if selected_shift_type == 'morning' %}selected{% endif %}>صباحية</option>
                        <option value="evening" {% if selected_shift_type == 'evening' %}selected{% endif %}>مسائية</option>
                    </select>
                </div>

                <!-- أزرار -->
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter me-2"></i>تطبيق الفلترة
                    </button>
                    <a href="{{ url_for('attendance_index') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-2"></i>مسح الفلترة
                    </a>

                    {% if selected_employee or selected_company_id or selected_shift_type %}
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            تم تطبيق فلترة:
                            {% if selected_employee %}موظف: {{ selected_employee.full_name }}{% endif %}
                            {% if selected_company_id %} | شركة: {{ selected_company_id }}{% endif %}
                            {% if selected_shift_type and selected_shift_type != 'all' %} | وردية: {{ selected_shift_type }}{% endif %}
                        </small>
                    </div>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <!-- إحصائيات سريعة -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                إجمالي الموظفين</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_employees }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                الحضور</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ present_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                المتأخرين</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ late_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                الغياب</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ absent_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-times-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- جدول الحضور -->
    <div class="card shadow">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">سجلات الحضور</h6>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-info btn-sm" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i> تصدير
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="printTable()">
                    <i class="fas fa-print"></i> طباعة
                </button>
            </div>
        </div>
        <div class="card-body">
            {% if attendance_records %}
            <div class="table-responsive">
                <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                    <thead class="bg-light">
                        <tr>
                            <th>#</th>
                            <th>اسم الموظف</th>
                            <th>الوظيفة</th>
                            <th>الشركة</th>
                            <th>التاريخ</th>
                            <th>الوردية</th>
                            <th>الحالة</th>
                            <th>وقت الحضور</th>
                            <th>وقت الانصراف</th>
                            <th>ملاحظات</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in attendance_records %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>
                                <strong>{{ record.employee.full_name if record.employee else 'غير معروف' }}</strong>
                                {% if record.employee and record.employee.employee_id %}
                                <br>
                                <small class="text-muted">{{ record.employee.employee_id }}</small>
                                {% endif %}
                            </td>
                            <td>{{ record.employee.position if record.employee else '-' }}</td>
                            <td>{{ record.employee.company.name if record.employee and record.employee.company else '-' }}</td>
                            <td>{{ record.date.strftime('%Y-%m-%d') }}</td>
                            <td>
                                {% if record.shift_type == 'morning' %}
                                <span class="badge bg-info">صباحية</span>
                                {% else %}
                                <span class="badge bg-warning">مسائية</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if record.status == 'present' %}
                                <span class="badge bg-success">حاضر</span>
                                {% elif record.status == 'absent' %}
                                <span class="badge bg-danger">غائب</span>
                                {% elif record.status == 'late' %}
                                <span class="badge bg-warning">متأخر</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ record.status }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if record.check_in %}
                                <span class="text-success">{{ record.check_in.strftime('%H:%M') }}</span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if record.check_out %}
                                <span class="text-info">{{ record.check_out.strftime('%H:%M') }}</span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if record.notes %}
                                <span class="text-truncate" style="max-width: 150px;"
                                      title="{{ record.notes }}">
                                    {{ record.notes }}
                                </span>
                                {% else %}
                                <span class="text-muted">لا يوجد</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{{ url_for('edit_attendance', id=record.id) }}"
                                       class="btn btn-outline-primary" title="تعديل">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button"
                                            class="btn btn-outline-danger"
                                            title="حذف"
                                            onclick="confirmDelete({{ record.id }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">لا توجد سجلات حضور</h5>
                <p class="text-muted">لا توجد سجلات حضور للتاريخ المحدد</p>
                <a href="{{ url_for('prepare_attendance') }}" class="btn btn-primary">
                    <i class="fas fa-clipboard-check"></i> بدء التحضير
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function exportToExcel() {
    // يمكن إضافة دالة التصدير لاحقاً
    alert('سيتم تنفيذ التصدير في الإصدارات القادمة');
}

function printTable() {
    window.print();
}

function confirmDelete(attendanceId) {
    if (confirm('هل أنت متأكد من حذف سجل الحضور هذا؟')) {
        fetch(`/attendance/delete/${attendanceId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('حدث خطأ أثناء الحذف');
        });
    }
}

// تفعيل DataTables إذا موجود
document.addEventListener('DOMContentLoaded', function() {
    if ($.fn.DataTable) {
        $('#dataTable').DataTable({
            language: {
                url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/ar.json'
            },
            responsive: true,
            order: [[0, 'asc']]
        });
    }
});
</script>

<style>
@media print {
    .btn, .card-header .d-flex, .d-flex.justify-content-between {
        display: none !important;
    }

    .card {
        border: none !important;
        box-shadow: none !important;
    }
}
</style>
{% endblock %}
{% extends "base.html" %}

{% block title %}ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¸Ù - {{ employee.full_name }}{% endblock %}

{% block header %}ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¸Ù{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-user-edit me-2"></i>ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù: {{ employee.full_name }}
                </h6>
            </div>
            <div class="card-body">
                <form method="POST" id="employeeForm" class="needs-validation" novalidate>
                    <!-- Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="position" class="form-label">
                                <i class="fas fa-briefcase me-1"></i>Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="position" name="position" required
                                    {% if current_user.role != 'owner' %}disabled{% endif %}>
                                <option value="supervisor" {% if employee.position == 'supervisor' %}selected{% endif %}>Ù…Ø´Ø±Ù</option>
                                <option value="monitor" {% if employee.position == 'monitor' %}selected{% endif %}>Ù…Ø±Ø§Ù‚Ø¨ Ù†Ø¸Ø§ÙØ©</option>
                                <option value="worker" {% if employee.position == 'worker' %}selected{% endif %}>Ø¹Ø§Ù…Ù„ Ù†Ø¸Ø§ÙØ©</option>
                            </select>
                            <div class="invalid-feedback">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</div>
                            {% if current_user.role != 'owner' %}
                            <div class="form-text text-muted">Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ -->
                    <div id="allFields">
                        <!-- Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆØ§Ù„Ù‡Ø§ØªÙ -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="full_name" class="form-label">
                                    <i class="fas fa-user me-1"></i>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="full_name" name="full_name" required
                                       value="{{ employee.full_name }}" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
                                <div class="invalid-feedback">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="phone" class="form-label">
                                    <i class="fas fa-phone me-1"></i>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
                                </label>
                                <input type="tel" class="form-control" id="phone" name="phone"
                                       value="{{ employee.phone or '' }}" placeholder="+967 700 000 000" dir="ltr">
                            </div>
                        </div>

                        <!-- Ø§Ù„Ø´Ø±ÙƒØ© (ØªØ¸Ù‡Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù„Ù„Ù…Ø§Ù„Ùƒ) -->
                        {% if current_user.role == 'owner' %}
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="company_id" class="form-label">
                                    <i class="fas fa-building me-1"></i>Ø§Ù„Ø´Ø±ÙƒØ© <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="company_id" name="company_id" required onchange="updateSupervisorsByCompany()">
                                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ© --</option>
                                    {% for company in companies %}
                                    <option value="{{ company.id }}" {% if employee.company_id == company.id %}selected{% endif %}>
                                        {{ company.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø±ÙƒØ©</div>
                                <small class="text-muted">ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ø±ÙƒØ© Ø³ÙŠØ¤Ø¯ÙŠ Ø¥Ù„Ù‰ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ†</small>
                            </div>

                            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© -->
                            {% if employee.company %}
                            <div class="col-md-6 mb-3">
                                <div class="alert alert-info py-2">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <strong>Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</strong> {{ employee.company.name }}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label for="address" class="form-label">
                                    <i class="fas fa-map-marker-alt me-1"></i>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
                                </label>
                                <textarea class="form-control" id="address" name="address" rows="2"
                                          placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„...">{{ employee.address or '' }}</textarea>
                            </div>
                        </div>

                        <!-- Ø§Ù„Ø±Ø§ØªØ¨ ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ† ÙˆØ§Ù„Ø­Ø§Ù„Ø© -->
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="salary" class="form-label">
                                    <i class="fas fa-money-bill me-1"></i>Ø§Ù„Ø±Ø§ØªØ¨ (Ø±ÙŠØ§Ù„ ÙŠÙ…Ù†ÙŠ)
                                </label>
                                <input type="number" class="form-control" id="salary" name="salary" step="0.01"
                                       value="{{ employee.salary }}" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ" min="0">
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="hire_date" class="form-label">
                                    <i class="fas fa-calendar-alt me-1"></i>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ† <span class="text-danger">*</span>
                                </label>
                                <input type="date" class="form-control" id="hire_date" name="hire_date"
                                       value="{{ employee.hire_date }}" required max="{{ today }}">
                                <div class="invalid-feedback">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ†</div>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label class="form-label d-block">
                                    <i class="fas fa-toggle-on me-1"></i>Ø§Ù„Ø­Ø§Ù„Ø©
                                </label>
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" id="is_active" name="is_active"
                                           {% if employee.is_active %}checked{% endif %}>
                                    <label class="form-check-label" for="is_active">
                                        <span class="badge bg-{{ 'success' if employee.is_active else 'secondary' }}">
                                            {{ 'Ù†Ø´Ø·' if employee.is_active else 'ØºÙŠØ± Ù†Ø´Ø·' }}
                                        </span>
                                    </label>
                                </div>
                                <div class="form-text">ÙŠÙ…ÙƒÙ† ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ø¤Ù‚ØªØ§Ù‹</div>
                            </div>
                        </div>

                        <!-- Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ù…Ø¨Ø§Ø´Ø± - Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ† ÙˆØ§Ù„Ø¹Ù…Ø§Ù„ -->
                        <div class="row" id="supervisorRow" style="display: {% if employee.position in ['monitor', 'worker'] %}block{% else %}none{% endif %};">
                            <div class="col-md-6 mb-3">
                                <label for="supervisor_id" class="form-label">
                                    <i class="fas fa-user-tie me-1"></i>Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
                                </label>
                                <select class="form-select" id="supervisor_id" name="supervisor_id">
                                    <option value="">-- Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø±Ù Ù…Ø¨Ø§Ø´Ø± --</option>
                                    {% for supervisor in supervisors %}
                                    <option value="{{ supervisor.id }}"
                                            data-company="{{ supervisor.company_id }}"
                                            data-name="{{ supervisor.full_name }}"
                                            {% if employee.supervisor_id == supervisor.id %}selected{% endif %}
                                            class="supervisor-option company-{{ supervisor.company_id }}">
                                        {{ supervisor.full_name }}
                                        {% if supervisor.company %} - {{ supervisor.company.name }}{% endif %}
                                        {% if supervisor.id == employee.supervisor_id %} (Ø§Ù„Ø­Ø§Ù„ÙŠ){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1 text-info"></i>
                                    Ø§Ø®ØªØ± Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù (Ø³ÙŠØªÙ… ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©)
                                </div>
                                {% if employee.supervisor %}
                                <div class="mt-2">
                                    <span class="badge bg-info">Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ø­Ø§Ù„ÙŠ: {{ employee.supervisor.full_name }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… - ØªØ¸Ù‡Ø± Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø· -->
                        <div id="userFields" style="display: {% if employee.position == 'supervisor' %}block{% else %}none{% endif %};">
                            <hr class="my-4">
                            <div class="alert alert-primary mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:</strong> Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø´Ø±Ù
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="username" class="form-label">
                                        <i class="fas fa-user-circle me-1"></i>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="username" name="username"
                                               value="{{ employee.user.username if employee.user else '' }}"
                                               placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"
                                               {% if employee.position == 'supervisor' %}required{% endif %}
                                               autocomplete="off">
                                        <button class="btn btn-outline-secondary" type="button" id="checkUsernameBtn" {% if not employee.user %}disabled{% endif %}>
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                    <div class="invalid-feedback username-feedback"></div>
                                    <div class="form-text">3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„</div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-key me-1"></i>ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                                    </label>
                                    <div class="alert alert-warning py-2 px-3 mb-2">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        <small>Ø§ØªØ±Ùƒ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙØ§Ø±ØºØ© Ø¥Ø°Ø§ ÙƒÙ†Øª Ù„Ø§ ØªØ±ÙŠØ¯ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</small>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="password" class="form-label">
                                        <i class="fas fa-key me-1"></i>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                                    </label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="password" name="password"
                                               placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" autocomplete="off">
                                        <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ - Ø§ØªØ±Ùƒ ÙØ§Ø±ØºØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ØªØ±Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±</div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="confirm_password" class="form-label">
                                        <i class="fas fa-check-circle me-1"></i>ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                                    </label>
                                    <input type="password" class="form-control" id="confirm_password" name="confirm_password"
                                           placeholder="Ø£Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="off">
                                    <div class="invalid-feedback" id="passwordMatchFeedback"></div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-12">
                                    <button class="btn btn-sm btn-info" type="button" id="generatePasswordBtn">
                                        <i class="fas fa-random me-1"></i>ØªÙˆÙ„ÙŠØ¯ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
                        <div class="alert alert-info mt-4">
                            <h6 class="alert-heading">
                                <i class="fas fa-info-circle me-2"></i>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù‡Ù…Ø©
                            </h6>
                            <ul class="mb-0 small">
                                <li>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªÙŠ ØªØ­Ù…Ù„ Ø¹Ù„Ø§Ù…Ø© <span class="text-danger">*</span> Ø¥Ù„Ø²Ø§Ù…ÙŠØ©</li>
                                <li>ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</li>
                                {% if employee.user %}
                                <li class="text-primary">
                                    <i class="fas fa-check-circle me-1"></i>
                                    Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ø¯ÙŠÙ‡ Ø­Ø³Ø§Ø¨ Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø´Ø· (Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {{ employee.user.username }})
                                </li>
                                {% endif %}
                                {% if employee.company %}
                                <li class="text-success">
                                    <i class="fas fa-building me-1"></i>
                                    Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: {{ employee.company.name }}
                                </li>
                                {% endif %}
                                {% if employee.supervisor %}
                                <li class="text-warning">
                                    <i class="fas fa-user-tie me-1"></i>
                                    Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ø­Ø§Ù„ÙŠ: {{ employee.supervisor.full_name }}
                                </li>
                                {% endif %}
                                <li class="text-info">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: {{ employee.created_at.strftime('%Y-%m-%d %H:%M') if employee.created_at else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</li>
                                <li class="text-info">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: {{ employee.updated_at.strftime('%Y-%m-%d %H:%M') if employee.updated_at else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</li>
                            </ul>
                        </div>

                        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a href="{{ url_for('employees_list') }}" class="btn btn-secondary me-md-2">
                                <i class="fas fa-arrow-right me-1"></i>Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†
                            </a>
                            <button type="submit" class="btn btn-warning" id="submitBtn">
                                <i class="fas fa-save me-1"></i>ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const positionSelect = document.getElementById('position');
    const supervisorRow = document.getElementById('supervisorRow');
    const userFields = document.getElementById('userFields');
    const companySelect = document.getElementById('company_id');
    const supervisorSelect = document.getElementById('supervisor_id');

    console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù');

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ
    positionSelect.addEventListener('change', function() {
        const position = this.value;
        console.log('ğŸ“ ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³Ù…Ù‰ Ø¥Ù„Ù‰:', position);

        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø®Ø§ØµØ© Ø£ÙˆÙ„Ø§Ù‹
        supervisorRow.style.display = 'none';
        userFields.style.display = 'none';

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if (document.getElementById('username')) {
            document.getElementById('username').required = false;
            document.getElementById('password').required = false;
            document.getElementById('confirm_password').required = false;
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ù…Ù‰
        if (position === 'supervisor') {
            userFields.style.display = 'block';
            document.getElementById('username').required = true;
            console.log('âœ… ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù…Ø´Ø±Ù');

            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø´Ø±Ù
            if (supervisorSelect) {
                supervisorSelect.value = '';
            }
        }
        else if (position === 'monitor' || position === 'worker') {
            supervisorRow.style.display = 'block';
            console.log('âœ… ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨/Ø§Ù„Ø¹Ø§Ù…Ù„');

            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
            if (companySelect) {
                updateSupervisorsByCompany();
            }
        }
    });

    // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ø´Ø±ÙƒØ©
    window.updateSupervisorsByCompany = function() {
        if (!companySelect || !supervisorSelect) return;

        const companyId = companySelect.value;
        console.log('ğŸ¢ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø±ÙƒØ©:', companyId);

        const options = supervisorSelect.querySelectorAll('.supervisor-option');
        let hasVisibleOptions = false;

        options.forEach(option => {
            const optionCompany = option.getAttribute('data-company');

            if (!companyId) {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø´Ø±ÙƒØ©ØŒ Ù†Ø¸Ù‡Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†
                option.style.display = '';
                option.disabled = false;
                hasVisibleOptions = true;
            } else if (optionCompany === companyId) {
                // Ù…Ø´Ø±ÙÙŠÙ† Ù†ÙØ³ Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
                option.style.display = '';
                option.disabled = false;
                hasVisibleOptions = true;
            } else {
                // Ù…Ø´Ø±ÙÙŠÙ† Ø´Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰
                option.style.display = 'none';
                option.disabled = true;
            }
        });

        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù…Ø®ÙÙŠØ§Ù‹ØŒ Ù†Ø¹ÙŠØ¯ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…Ø©
        if (supervisorSelect.value) {
            const selectedOption = supervisorSelect.options[supervisorSelect.selectedIndex];
            if (selectedOption && selectedOption.disabled) {
                supervisorSelect.value = '';
                console.log('âš ï¸ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù„Ø£Ù†Ù‡ Ù…Ù† Ø´Ø±ÙƒØ© Ù…Ø®ØªÙ„ÙØ©');
            }
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø´Ø±ÙÙŠÙ†
        const noSupervisorsMsg = document.getElementById('noSupervisorsMsg');
        if (!noSupervisorsMsg) {
            const msg = document.createElement('option');
            msg.id = 'noSupervisorsMsg';
            msg.value = '';
            msg.textContent = '-- Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø±ÙÙŠÙ† ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø±ÙƒØ© --';
            msg.disabled = true;
            msg.style.color = '#999';
            if (!hasVisibleOptions && companyId) {
                supervisorSelect.appendChild(msg);
            }
        } else {
            noSupervisorsMsg.style.display = hasVisibleOptions ? 'none' : '';
        }
    };

    // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    if (companySelect && supervisorSelect) {
        updateSupervisorsByCompany();

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ø±ÙƒØ©
        companySelect.addEventListener('change', function() {
            updateSupervisorsByCompany();

            // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            const selectedCompany = companySelect.options[companySelect.selectedIndex];
            if (selectedCompany && selectedCompany.value) {
                console.log('âœ… ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ø±ÙƒØ© Ø¥Ù„Ù‰:', selectedCompany.text);
            }
        });
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    document.getElementById('employeeForm').addEventListener('submit', function(e) {
        const position = positionSelect.value;
        const username = document.getElementById('username');
        const password = document.getElementById('password');
        const confirmPassword = document.getElementById('confirm_password');
        const companyId = companySelect ? companySelect.value : null;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø±ÙƒØ© Ù„Ù„Ù…Ø§Ù„Ùƒ
        {% if current_user.role == 'owner' %}
        if (!companyId) {
            e.preventDefault();
            alert('âš ï¸ ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø±ÙƒØ©');
            companySelect.focus();
            return false;
        }
        {% endif %}

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ†
        if (position === 'supervisor') {
            if (!username.value) {
                e.preventDefault();
                alert('âš ï¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ†');
                username.focus();
                return false;
            }

            if (username.value.length < 3) {
                e.preventDefault();
                alert('âš ï¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                username.focus();
                return false;
            }
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„Ù‡Ø§
        if (password && password.value) {
            if (password.value.length < 6) {
                e.preventDefault();
                alert('âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                password.focus();
                return false;
            }

            if (password.value !== confirmPassword.value) {
                e.preventDefault();
                alert('âš ï¸ ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†');
                confirmPassword.focus();
                return false;
            }
        }

        console.log('âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ù†Ø¬Ø§Ø­');
    });

    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    const togglePasswordBtn = document.getElementById('togglePassword');
    if (togglePasswordBtn) {
        togglePasswordBtn.addEventListener('click', function() {
            const passwordInput = document.getElementById('password');
            const icon = this.querySelector('i');

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });
    }

    // ØªÙˆÙ„ÙŠØ¯ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
    const generateBtn = document.getElementById('generatePasswordBtn');
    if (generateBtn) {
        generateBtn.addEventListener('click', function() {
            const length = 8;
            const charset = "abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            let password = "";
            for (let i = 0; i < length; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            document.getElementById('password').value = password;
            document.getElementById('confirm_password').value = password;

            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
            alert('âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
        });
    }

    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…
    const hireDate = document.getElementById('hire_date');
    if (hireDate) {
        hireDate.max = new Date().toISOString().split('T')[0];
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¥Ø°Ø§ ÙˆØ¬Ø¯
    const emailInput = document.getElementById('email');
    if (emailInput) {
        emailInput.addEventListener('blur', function() {
            const email = this.value;
            if (email && !isValidEmail(email)) {
                this.classList.add('is-invalid');
                alert('âš ï¸ ØµÙŠØºØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            } else {
                this.classList.remove('is-invalid');
            }
        });
    }
});

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
function isValidEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
}
</script>

<style>
    .card {
        border: none;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
    }
    .card-header {
        background-color: #f8f9fc;
        border-bottom: 1px solid #e3e6f0;
    }
    .form-label {
        font-weight: 500;
        color: #2c3e50;
        margin-bottom: 0.3rem;
    }
    .form-control:focus, .form-select:focus {
        border-color: #4e73df;
        box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
    }
    .alert-primary {
        background-color: #cce5ff;
        border-color: #b8daff;
        color: #004085;
    }
    .alert-info {
        background-color: #e1f5fe;
        border-color: #b3e5fc;
        color: #01579b;
    }
    .alert-warning {
        background-color: #fff3cd;
        border-color: #ffeeba;
        color: #856404;
    }
    .badge {
        font-size: 0.9rem;
        padding: 0.5rem 0.75rem;
    }
    #allFields {
        transition: all 0.3s ease;
    }
    .form-switch .form-check-input {
        width: 3em;
        height: 1.5em;
        margin-left: 0.5rem;
    }
    .form-switch .form-check-input:checked {
        background-color: #28a745;
        border-color: #28a745;
    }
    .supervisor-option {
        padding: 0.5rem;
    }
    #noSupervisorsMsg {
        font-style: italic;
        background-color: #f8f9fa;
    }
</style>
{% endblock %}
{% extends "base.html" %}

{% block title %}الملف الشخصي{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-header">
                <h1><i class="fas fa-user"></i> الملف الشخصي</h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">الرئيسية</a></li>
                        <li class="breadcrumb-item active">الملف الشخصي</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <!-- بطاقة معلومات المستخدم -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0"><i class="fas fa-id-card"></i> معلومات الحساب</h5>
                </div>
                <div class="card-body text-center">
                    <div class="user-avatar mb-3">
                        <i class="fas fa-user-circle fa-5x text-secondary"></i>
                    </div>
                    <h4>{{ current_user.username }}</h4>
                    <p class="text-muted">
                        {% if current_user.role == 'owner' %}
                            <span class="badge badge-success">مالك النظام</span>
                        {% elif current_user.role == 'supervisor' %}
                            <span class="badge badge-info">مشرف</span>
                        {% elif current_user.role == 'monitor' %}
                            <span class="badge badge-warning">مراقب</span>
                        {% elif current_user.role == 'worker' %}
                            <span class="badge badge-secondary">عامل</span>
                        {% endif %}
                    </p>
                    <p class="text-muted">{{ current_user.email }}</p>
                </div>
            </div>

            <!-- بطاقة الإحصائيات الشخصية -->
            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0"><i class="fas fa-chart-bar"></i> إحصائياتي</h5>
                </div>
                <div class="card-body">
                    {% if current_user.employee_profile %}
                        {% set employee = current_user.employee_profile %}
                        <div class="list-group list-group-flush">
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span>تاريخ التعيين</span>
                                <span class="badge badge-primary">{{ employee.hire_date.strftime('%Y-%m-%d') }}</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span>الحالة</span>
                                <span class="badge badge-{{ 'success' if employee.is_active else 'danger' }}">
                                    {{ 'نشط' if employee.is_active else 'غير نشط' }}
                                </span>
                            </div>
                            {% if current_user.role in ['supervisor', 'monitor', 'worker'] %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span>المسمى الوظيفي</span>
                                <span class="badge badge-secondary">
                                    {% if employee.position == 'supervisor' %}مشرف
                                    {% elif employee.position == 'monitor' %}مراقب
                                    {% elif employee.position == 'worker' %}عامل
                                    {% else %}{{ employee.position }}{% endif %}
                                </span>
                            </div>
                            {% endif %}
                        </div>
                    {% else %}
                        <p class="text-muted text-center">لا توجد معلومات إضافية</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <!-- معلومات الاتصال -->
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0"><i class="fas fa-address-book"></i> معلومات الاتصال</h5>
                </div>
                <div class="card-body">
                    {% if current_user.employee_profile %}
                        {% set employee = current_user.employee_profile %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label><strong>الاسم الكامل:</strong></label>
                                    <p class="form-control-plaintext">{{ employee.full_name }}</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label><strong>رقم الهاتف:</strong></label>
                                    <p class="form-control-plaintext">{{ employee.phone or 'غير محدد' }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="form-group">
                                    <label><strong>العنوان:</strong></label>
                                    <p class="form-control-plaintext">{{ employee.address or 'غير محدد' }}</p>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <p class="text-muted text-center">لا توجد معلومات اتصال متاحة</p>
                    {% endif %}
                </div>
            </div>

            <!-- التقييمات الحديثة (للعاملين) -->
            {% if current_user.role == 'worker' and current_user.employee_profile %}
            <div class="card mt-4">
                <div class="card-header bg-warning text-white">
                    <h5 class="card-title mb-0"><i class="fas fa-star"></i> آخر التقييمات</h5>
                </div>
                <div class="card-body">
                    {% set evaluations = current_user.employee_profile.evaluations_received|sort(attribute='date', reverse=true)|list %}
                    {% if evaluations %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>التاريخ</th>
                                        <th>المكان</th>
                                        <th>التقييم</th>
                                        <th>الملاحظات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for eval in evaluations[:5] %}
                                    <tr>
                                        <td>{{ eval.date.strftime('%Y-%m-%d') }}</td>
                                        <td>{{ eval.place.name if eval.place else 'غير محدد' }}</td>
                                        <td>
                                            <span class="badge badge-{{ 'success' if eval.overall_score >= 4 else 'warning' if eval.overall_score >= 3 else 'danger' }}">
                                                {{ "%.1f"|format(eval.overall_score) }}/5
                                            </span>
                                        </td>
                                        <td>{{ eval.comments or 'لا توجد ملاحظات' }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted text-center">لا توجد تقييمات حتى الآن</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- الإجراءات السريعة -->
            <div class="card mt-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="card-title mb-0"><i class="fas fa-bolt"></i> إجراءات سريعة</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% if current_user.role in ['owner', 'supervisor', 'monitor'] %}
                        <div class="col-md-6 mb-2">
                            <a href="{{ url_for('add_evaluation') }}" class="btn btn-primary btn-block">
                                <i class="fas fa-plus"></i> إضافة تقييم
                            </a>
                        </div>
                        {% endif %}

                        {% if current_user.role in ['owner', 'supervisor'] %}
                        <div class="col-md-6 mb-2">
                            <a href="{{ url_for('add_attendance') }}" class="btn btn-success btn-block">
                                <i class="fas fa-user-check"></i> تسجيل حضور
                            </a>
                        </div>
                        {% endif %}

                        <div class="col-md-6 mb-2">
                            <a href="{{ url_for('my_attendance') }}" class="btn btn-info btn-block">
                                <i class="fas fa-history"></i> سجل حضوري
                            </a>
                        </div>

                        <div class="col-md-6 mb-2">
                            <a href="{{ url_for('logout') }}" class="btn btn-outline-danger btn-block"
                               onclick="return confirm('هل أنت متأكد من تسجيل الخروج؟')">
                                <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}